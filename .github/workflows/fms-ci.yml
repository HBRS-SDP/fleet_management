name: Fleet Management CI

on: push

env:
  CONTAINER_TEST_IMAGE: docker.pkg.github.com/hbrs-sdp/fleet_management/fms:test
  IMAGE_NAME: fms

jobs:
  build_fms:
    runs-on: ubuntu-16.04
    steps:
      - uses: actions/checkout@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Login to docker registry
        uses: docker/login-action@v1
        with:
          registry: docker.pkg.github.com
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build image
        uses: docker/build-push-action@v2
        with:
          context: .
          push: true
          file: ./Dockerfile
          tags: docker.pkg.github.com/hbrs-sdp/fleet_management/fms:test
  # build_fms:
  #   runs-on: ubuntu-16.04
  #   steps:
  #     - uses: actions/checkout@v2

  #     - name: build docker fms image
  #       run: docker build -t $IMAGE_NAME .

  #     - name: Log into registry
  #       run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin

  #     - name: Push image
  #       run: |
  #         IMAGE_ID=docker.pkg.github.com/${{ github.repository }}/$IMAGE_NAME
  #         IMAGE_ID=$(echo $IMAGE_ID | tr '[A-Z]' '[a-z]')
  #         VERSION=test
  #         echo IMAGE_ID=$IMAGE_ID
  #         echo VERSION=$VERSION
  #         docker tag $IMAGE_NAME $IMAGE_ID:$VERSION
  #         docker push $IMAGE_ID:$VERSION

  build_osm_brsu:
    runs-on: ubuntu-16.04
    steps:
      - uses: actions/checkout@v2

      - name: build docker osm image
        run: docker build -t hbrs-sdp/docker-overpass-api:latest https://github.com/ropod-project/docker-overpass-api.git#brsu

      - name: save osm image
        run: docker save -o osm_brsu.tar.gz hbrs-sdp/docker-overpass-api

      - name: upload osm image
        uses: actions/upload-artifact@v2
        with:
          name: osm_image
          path: osm_brsu.tar.gz
          retention-days: 1

  build_com_mediator:
    runs-on: ubuntu-16.04
    steps:
      - uses: actions/checkout@v2

      - name: build com_mediator image
        run: |
          git clone https://github.com/ropod-project/ropod_com_mediator.git
          cd ropod_com_mediator
          sed -i 's,git.ropod.org:4567/ropod/ropod_common:latest,ropod/ropod_common:latest,g' Dockerfile
          docker build -t ropod/ropod_com_mediator:latest .

      - name: save com_mediator image
        run: docker save -o com_mediator.tar.gz ropod/ropod_com_mediator

      - name: upload com_mediator image
        uses: actions/upload-artifact@v2
        with:
          name: com_mediator_image
          path: com_mediator.tar.gz
          retention-days: 1

  docs:
    runs-on: ubuntu-16.04
    steps:
      - uses: actions/checkout@v2

      - name: Set up Python 3.6
        uses: actions/setup-python@v2
        with:
          python-version: "3.6"

      - name: install dependencies
        run: |
          sudo apt-get -y install make gcc
          pip install sphinx sphinx_rtd_theme

      - name: make docs
        run: |
          cd docs
          make html
          cp -rf _build/html .

      - name: store docs
        continue-on-error: true
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add docs/html/*
          git commit -m "push docs generated from ${{ github.sha }}"
          git push

  pylint:
    runs-on: ubuntu-16.04
    steps:
      - uses: actions/checkout@v2

      - name: Set up Python 3.6
        uses: actions/setup-python@v2
        with:
          python-version: "3.6"

      - name: install dependencies
        run: |
          pip install pylint
          pip install anybadge

      - name: run pylint
        run: |
          rm pylint.svg
          python3 .travis/lint.py

      - name: store pylint resuts
        continue-on-error: true
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add pylint.svg
          git commit -m "pylint results from ${{ github.sha }}"
          git push

  coverage:
    needs: [build_fms, build_osm_brsu]

    runs-on: ubuntu-16.04

    steps:
      - uses: actions/checkout@v2

      - name: Log into registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin

      - name: pull fms image
        run: docker pull docker.pkg.github.com/hbrs-sdp/fleet_management/fms:test

      - name: run coverage test
        run: docker run $CONTAINER_TEST_IMAGE pytest --collect-only --cov=fleet_management test/fms

  resource_management_test:
    needs: [build_fms, build_osm_brsu]

    runs-on: ubuntu-16.04
    steps:
      - uses: actions/checkout@v2

      - name: Log into registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin

      - name: pull fms image
        run: docker pull docker.pkg.github.com/hbrs-sdp/fleet_management/fms:test

      - name: run resource_management test
        run: |
          docker run $CONTAINER_TEST_IMAGE pytest test/fms/resources/fleet
          docker run $CONTAINER_TEST_IMAGE pytest test/fms/resources/infrastructure

  osm_com_mediator_test:
    needs: [build_com_mediator, coverage, resource_management_test]

    runs-on: ubuntu-16.04

    steps:
      - uses: actions/checkout@v2

      - name: Log into registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin

      - name: pull fms image
        run: docker pull docker.pkg.github.com/hbrs-sdp/fleet_management/fms:test

      - name: download com_mediator image
        uses: actions/download-artifact@v2
        with:
          name: com_mediator_image

      - name: load com_mediator image
        run: docker load -i com_mediator.tar.gz

      - name: download osm image
        uses: actions/download-artifact@v2
        with:
          name: osm_image

      - name: load osm image
        run: docker load -i osm_brsu.tar.gz

      - name: run com_mediator test
        run: |
          docker-compose up -d roscore
          docker-compose -f .travis/docker-compose.yml up --exit-code-from osm_com_mediator_test osm_com_mediator_test osm_robot_proxy_1 osm_robot_1 task_relay osm_task_requester fms_osm com_mediator
          docker-compose logs

      - name: stop docker images
        run: docker stop $(docker ps -aq)

  osm_path_planner_requests:
    needs: [coverage, resource_management_test]

    runs-on: ubuntu-16.04

    steps:
      - uses: actions/checkout@v2

      - name: Log into registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin

      - name: pull fms image
        run: docker pull docker.pkg.github.com/hbrs-sdp/fleet_management/fms:test

      - name: download osm image
        uses: actions/download-artifact@v2
        with:
          name: osm_image

      - name: load osm image
        run: docker load -i osm_brsu.tar.gz

      - name: run path planner test
        run: |
          docker-compose -f .travis/docker-compose.yml up osm_path_planner_test
          docker-compose logs

      - name: stop docker images
        run: docker stop $(docker ps -aq)

  osm_query_interface:
    needs: [coverage, resource_management_test]

    runs-on: ubuntu-16.04

    steps:
      - uses: actions/checkout@v2

      - name: Log into registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin

      - name: pull fms image
        run: docker pull docker.pkg.github.com/hbrs-sdp/fleet_management/fms:test

      - name: download osm image
        uses: actions/download-artifact@v2
        with:
          name: osm_image

      - name: load osm image
        run: docker load -i osm_brsu.tar.gz

      - name: run path planner test
        run: |
          docker-compose up -d roscore
          docker-compose -f .travis/docker-compose.yml up --exit-code-from osm_query_interface_test osm_query_interface_test
          docker-compose logs

      - name: stop docker images
        run: docker stop $(docker ps -aq)

  topology_com_mediator_test:
    needs: [build_com_mediator, coverage, resource_management_test]

    runs-on: ubuntu-16.04

    steps:
      - uses: actions/checkout@v2

      - name: Log into registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin

      - name: pull fms image
        run: docker pull docker.pkg.github.com/hbrs-sdp/fleet_management/fms:test

      - name: download com_mediator image
        uses: actions/download-artifact@v2
        with:
          name: com_mediator_image

      - name: load com_mediator image
        run: docker load -i com_mediator.tar.gz

      - name: run com_mediator test
        run: |
          docker-compose up -d roscore
          docker-compose -f .travis/docker-compose.yml up --exit-code-from topology_com_mediator_test topology_com_mediator_test topology_robot_proxy_1 topology_robot_1 task_relay topology_task_requester fms_topology com_mediator
          docker-compose logs

      - name: stop docker images
        run: docker stop $(docker ps -aq)

  topology_path_planner_requests:
    needs: [coverage, resource_management_test]

    runs-on: ubuntu-16.04

    steps:
      - uses: actions/checkout@v2

      - name: Log into registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin

      - name: pull fms image
        run: docker pull docker.pkg.github.com/hbrs-sdp/fleet_management/fms:test

      - name: run path planner test
        run: |
          docker-compose -f .travis/docker-compose.yml up topology_path_planner_test
          docker-compose logs

      - name: stop docker images
        run: docker stop $(docker ps -aq)

  topology_query_interface:
    needs: [coverage, resource_management_test]

    runs-on: ubuntu-16.04

    steps:
      - uses: actions/checkout@v2

      - name: Log into registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin

      - name: pull fms image
        run: docker pull docker.pkg.github.com/hbrs-sdp/fleet_management/fms:test

      - name: run path planner test
        run: |
          docker-compose up -d roscore
          docker-compose -f .travis/docker-compose.yml up --exit-code-from topology_query_interface_test topology_query_interface_test
          docker-compose logs

      - name: stop docker images
        run: docker stop $(docker ps -aq)

  osm_task_request_case_1:
    needs:
      [osm_com_mediator_test, osm_path_planner_requests, osm_query_interface]

    runs-on: ubuntu-16.04

    steps:
      - uses: actions/checkout@v2

      - name: Log into registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin

      - name: pull fms image
        run: docker pull docker.pkg.github.com/hbrs-sdp/fleet_management/fms:test

      - name: download osm image
        uses: actions/download-artifact@v2
        with:
          name: osm_image

      - name: load osm image
        run: docker load -i osm_brsu.tar.gz

      - name: run task request case 1
        run: |
          docker-compose up -d roscore
          docker-compose -f .travis/docker-compose.yml up --exit-code-from osm_task_test_1 osm_task_test_1 fms_osm osm_robot_proxy_1 osm_robot_1
          docker-compose logs

      - name: stop docker images
        run: docker stop $(docker ps -aq)

  osm_task_request_case_2:
    needs:
      [osm_com_mediator_test, osm_path_planner_requests, osm_query_interface]

    runs-on: ubuntu-16.04

    steps:
      - uses: actions/checkout@v2

      - name: Log into registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin

      - name: pull fms image
        run: docker pull docker.pkg.github.com/hbrs-sdp/fleet_management/fms:test

      - name: download osm image
        uses: actions/download-artifact@v2
        with:
          name: osm_image

      - name: load osm image
        run: docker load -i osm_brsu.tar.gz

      - name: run task request case 2
        run: |
          docker-compose up -d roscore
          docker-compose -f .travis/docker-compose.yml up --exit-code-from osm_task_test_2 osm_task_test_2 fms_osm osm_robot_proxy_1 osm_robot_1
          docker-compose logs

      - name: stop docker images
        run: docker stop $(docker ps -aq)

  osm_task_request_case_3:
    needs:
      [osm_com_mediator_test, osm_path_planner_requests, osm_query_interface]

    runs-on: ubuntu-16.04

    steps:
      - uses: actions/checkout@v2

      - name: Log into registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin

      - name: pull fms image
        run: docker pull docker.pkg.github.com/hbrs-sdp/fleet_management/fms:test

      - name: download osm image
        uses: actions/download-artifact@v2
        with:
          name: osm_image

      - name: load osm image
        run: docker load -i osm_brsu.tar.gz

      - name: run task request case 3
        run: |
          docker-compose up -d roscore
          docker-compose -f .travis/docker-compose.yml up --exit-code-from osm_task_test_3 osm_task_test_3 fms_osm osm_robot_proxy_1 osm_robot_1
          docker-compose logs

      - name: stop docker images
        run: docker stop $(docker ps -aq)

  osm_task_request_case_4:
    needs:
      [osm_com_mediator_test, osm_path_planner_requests, osm_query_interface]

    runs-on: ubuntu-16.04

    steps:
      - uses: actions/checkout@v2

      - name: Log into registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin

      - name: pull fms image
        run: docker pull docker.pkg.github.com/hbrs-sdp/fleet_management/fms:test

      - name: download osm image
        uses: actions/download-artifact@v2
        with:
          name: osm_image

      - name: load osm image
        run: docker load -i osm_brsu.tar.gz

      - name: run task request case 4
        run: |
          docker-compose up -d roscore
          docker-compose -f .travis/docker-compose.yml up --exit-code-from osm_task_test_4 osm_task_test_4 fms_osm osm_robot_proxy_1 osm_robot_1
          docker-compose logs

      - name: stop docker images
        run: docker stop $(docker ps -aq)

  osm_task_request_case_5:
    needs:
      [osm_com_mediator_test, osm_path_planner_requests, osm_query_interface]

    runs-on: ubuntu-16.04

    steps:
      - uses: actions/checkout@v2

      - name: Log into registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin

      - name: pull fms image
        run: docker pull docker.pkg.github.com/hbrs-sdp/fleet_management/fms:test

      - name: download osm image
        uses: actions/download-artifact@v2
        with:
          name: osm_image

      - name: load osm image
        run: docker load -i osm_brsu.tar.gz

      - name: run task request case 5
        run: |
          docker-compose up -d roscore
          docker-compose -f .travis/docker-compose.yml up --exit-code-from osm_task_test_5 osm_task_test_5 fms_osm osm_robot_proxy_1 osm_robot_1
          docker-compose logs

      - name: stop docker images
        run: docker stop $(docker ps -aq)

  osm_task_request_case_6:
    needs:
      [osm_com_mediator_test, osm_path_planner_requests, osm_query_interface]

    runs-on: ubuntu-16.04

    steps:
      - uses: actions/checkout@v2

      - name: Log into registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin

      - name: pull fms image
        run: docker pull docker.pkg.github.com/hbrs-sdp/fleet_management/fms:test

      - name: download osm image
        uses: actions/download-artifact@v2
        with:
          name: osm_image

      - name: load osm image
        run: docker load -i osm_brsu.tar.gz

      - name: run task request case 6
        run: |
          docker-compose up -d roscore
          docker-compose -f .travis/docker-compose.yml up --exit-code-from osm_task_test_6 osm_task_test_6 fms_osm osm_robot_proxy_1 osm_robot_1
          docker-compose logs

      - name: stop docker images
        run: docker stop $(docker ps -aq)

  osm_task_request_case_7:
    needs:
      [osm_com_mediator_test, osm_path_planner_requests, osm_query_interface]

    runs-on: ubuntu-16.04

    steps:
      - uses: actions/checkout@v2

      - name: Log into registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin

      - name: pull fms image
        run: docker pull docker.pkg.github.com/hbrs-sdp/fleet_management/fms:test

      - name: download osm image
        uses: actions/download-artifact@v2
        with:
          name: osm_image

      - name: load osm image
        run: docker load -i osm_brsu.tar.gz

      - name: run task request case 7
        run: |
          docker-compose up -d roscore
          docker-compose -f .travis/docker-compose.yml up --exit-code-from osm_task_test_7 osm_task_test_7 fms_osm osm_robot_proxy_1 osm_robot_1
          docker-compose logs

      - name: stop docker images
        run: docker stop $(docker ps -aq)

  osm_task_request_case_8:
    needs:
      [osm_com_mediator_test, osm_path_planner_requests, osm_query_interface]

    runs-on: ubuntu-16.04

    steps:
      - uses: actions/checkout@v2

      - name: Log into registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin

      - name: pull fms image
        run: docker pull docker.pkg.github.com/hbrs-sdp/fleet_management/fms:test

      - name: download osm image
        uses: actions/download-artifact@v2
        with:
          name: osm_image

      - name: load osm image
        run: docker load -i osm_brsu.tar.gz

      - name: run task request case 8
        run: |
          docker-compose up -d roscore
          docker-compose -f .travis/docker-compose.yml up --exit-code-from osm_task_test_8 osm_task_test_8 fms_osm osm_robot_proxy_1 osm_robot_1
          docker-compose logs

      - name: stop docker images
        run: docker stop $(docker ps -aq)

  topology_task_request_case_1:
    needs: [topology_path_planner_requests, topology_query_interface]

    runs-on: ubuntu-16.04

    steps:
      - uses: actions/checkout@v2

      - name: Log into registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin

      - name: pull fms image
        run: docker pull docker.pkg.github.com/hbrs-sdp/fleet_management/fms:test

      - name: run task request case 1
        run: |
          docker-compose up -d roscore
          docker-compose -f .travis/docker-compose.yml up --exit-code-from topology_task_test_1 topology_task_test_1 fms_topology topology_robot_proxy_1 topology_robot_1
          docker-compose logs

      - name: stop docker images
        run: docker stop $(docker ps -aq)

  topology_task_request_case_2:
    needs: [topology_path_planner_requests, topology_query_interface]

    runs-on: ubuntu-16.04

    steps:
      - uses: actions/checkout@v2

      - name: Log into registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin

      - name: pull fms image
        run: docker pull docker.pkg.github.com/hbrs-sdp/fleet_management/fms:test

      - name: run task request case 2
        run: |
          docker-compose up -d roscore
          docker-compose -f .travis/docker-compose.yml up --exit-code-from topology_task_test_2 topology_task_test_2 fms_topology topology_robot_proxy_1 topology_robot_1
          docker-compose logs

      - name: stop docker images
        run: docker stop $(docker ps -aq)

  topology_task_request_case_3:
    needs: [topology_path_planner_requests, topology_query_interface]

    runs-on: ubuntu-16.04

    steps:
      - uses: actions/checkout@v2

      - name: Log into registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin

      - name: pull fms image
        run: docker pull docker.pkg.github.com/hbrs-sdp/fleet_management/fms:test

      - name: run task request case 3
        run: |
          docker-compose up -d roscore
          docker-compose -f .travis/docker-compose.yml up --exit-code-from topology_task_test_3 topology_task_test_3 fms_topology topology_robot_proxy_1 topology_robot_1
          docker-compose logs

      - name: stop docker images
        run: docker stop $(docker ps -aq)

  topology_task_request_case_4:
    needs: [topology_path_planner_requests, topology_query_interface]

    runs-on: ubuntu-16.04

    steps:
      - uses: actions/checkout@v2

      - name: Log into registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin

      - name: pull fms image
        run: docker pull docker.pkg.github.com/hbrs-sdp/fleet_management/fms:test

      - name: run task request case 4
        run: |
          docker-compose up -d roscore
          docker-compose -f .travis/docker-compose.yml up --exit-code-from topology_task_test_4 topology_task_test_4 fms_topology topology_robot_proxy_1 topology_robot_1
          docker-compose logs

      - name: stop docker images
        run: docker stop $(docker ps -aq)

  topology_task_request_case_5:
    needs: [topology_path_planner_requests, topology_query_interface]

    runs-on: ubuntu-16.04

    steps:
      - uses: actions/checkout@v2

      - name: Log into registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin

      - name: pull fms image
        run: docker pull docker.pkg.github.com/hbrs-sdp/fleet_management/fms:test

      - name: run task request case 5
        run: |
          docker-compose up -d roscore
          docker-compose -f .travis/docker-compose.yml up --exit-code-from topology_task_test_5 topology_task_test_5 fms_topology topology_robot_proxy_1 topology_robot_1
          docker-compose logs

      - name: stop docker images
        run: docker stop $(docker ps -aq)

  topology_task_request_case_6:
    needs: [topology_path_planner_requests, topology_query_interface]

    runs-on: ubuntu-16.04

    steps:
      - uses: actions/checkout@v2

      - name: Log into registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin

      - name: pull fms image
        run: docker pull docker.pkg.github.com/hbrs-sdp/fleet_management/fms:test

      - name: run task request case 6
        run: |
          docker-compose up -d roscore
          docker-compose -f .travis/docker-compose.yml up --exit-code-from topology_task_test_6 topology_task_test_6 fms_topology topology_robot_proxy_1 topology_robot_1
          docker-compose logs

      - name: stop docker images
        run: docker stop $(docker ps -aq)

  topology_task_request_case_7:
    needs: [topology_path_planner_requests, topology_query_interface]

    runs-on: ubuntu-16.04

    steps:
      - uses: actions/checkout@v2

      - name: Log into registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin

      - name: pull fms image
        run: docker pull docker.pkg.github.com/hbrs-sdp/fleet_management/fms:test

      - name: run task request case 7
        run: |
          docker-compose up -d roscore
          docker-compose -f .travis/docker-compose.yml up --exit-code-from topology_task_test_7 topology_task_test_7 fms_topology topology_robot_proxy_1 topology_robot_1
          docker-compose logs

      - name: stop docker images
        run: docker stop $(docker ps -aq)

  topology_task_request_case_8:
    needs: [topology_path_planner_requests, topology_query_interface]

    runs-on: ubuntu-16.04

    steps:
      - uses: actions/checkout@v2

      - name: Log into registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin

      - name: pull fms image
        run: docker pull docker.pkg.github.com/hbrs-sdp/fleet_management/fms:test

      - name: run task request case 8
        run: |
          docker-compose up -d roscore
          docker-compose -f .travis/docker-compose.yml up --exit-code-from topology_task_test_8 topology_task_test_8 fms_topology topology_robot_proxy_1 topology_robot_1
          docker-compose logs

      - name: stop docker images
        run: docker stop $(docker ps -aq)

  push_fms_image_to_github:
    needs:
      [
        osm_task_request_case_1,
        osm_task_request_case_2,
        osm_task_request_case_3,
        osm_task_request_case_4,
        osm_task_request_case_5,
        osm_task_request_case_6,
        osm_task_request_case_7,
        osm_task_request_case_8,
        topology_task_request_case_1,
        topology_task_request_case_2,
        topology_task_request_case_3,
        topology_task_request_case_4,
        topology_task_request_case_5,
        topology_task_request_case_6,
        topology_task_request_case_7,
        topology_task_request_case_8,
      ]

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - name: Build image
        run: docker build -t $IMAGE_NAME .
      - name: Log into registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin
      - name: Push image
        run: |
          IMAGE_ID=docker.pkg.github.com/${{ github.repository }}/$IMAGE_NAME
          # Change all uppercase to lowercase
          IMAGE_ID=$(echo $IMAGE_ID | tr '[A-Z]' '[a-z]')
          # Strip git ref prefix from version
          VERSION=$(echo "${{ github.ref }}" | sed -e 's,.*/\(.*\),\1,')
          # Strip "v" prefix from tag name
          [[ "${{ github.ref }}" == "refs/tags/"* ]] && VERSION=$(echo $VERSION | sed -e 's/^v//')
          # Use Docker `latest` tag convention
          [ "$VERSION" == "master" ] && VERSION=latest          echo IMAGE_ID=$IMAGE_ID
          echo VERSION=$VERSION
          docker tag $IMAGE_NAME $IMAGE_ID:$VERSION
          docker push $IMAGE_ID:$VERSION
